<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenStreetMap Test - Bus Tracking System</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map {
            height: 500px;
            border-radius: 10px;
        }
        .test-controls {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">🗺️ OpenStreetMap Test - Bus Tracking System</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>OpenStreetMap with Leaflet</h5>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Controls</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2 w-100" onclick="testRoute()">
                            🛣️ Test Route (Delhi → Lucknow)
                        </button>
                        <button class="btn btn-primary mb-2 w-100" onclick="testBanarasRoute()">
                            🛣️ Test Banaras Route (Banaras → Haldwani)
                        </button>
                        <button class="btn btn-success mb-2 w-100" onclick="testBusMarker()">
                            🚌 Add Test Bus
                        </button>
                        <button class="btn btn-warning mb-2 w-100" onclick="testMovingBus()">
                            🏃‍♂️ Simulate Moving Bus
                        </button>
                        <button class="btn btn-danger mb-2 w-100" onclick="clearMap()">
                            🧹 Clear Map
                        </button>
                        <button class="btn btn-info mb-2 w-100" onclick="fitAllBuses()">
                            🔍 Fit to All Buses
                        </button>
                        
                        <div class="mt-3">
                            <h6>Features Testing:</h6>
                            <div id="testResults">
                                <div class="alert alert-info">
                                    Click buttons above to test OpenStreetMap features
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Our Geocoding Service -->
    <script src="public/js/geocoding-service.js"></script>
    <!-- Our LeafletMapsService -->
    <script src="public/js/leaflet-maps-service.js"></script>

    <script>
        let mapsService;
        let testBusCount = 0;
        
        // Initialize the map
        async function initMap() {
            try {
                mapsService = new LeafletMapsService();
                await mapsService.initMap('map', {
                    zoom: 6,
                    center: [20.5937, 78.9629] // India center
                });
                
                updateTestResults('✅ OpenStreetMap initialized successfully!', 'success');
                console.log('OpenStreetMap initialized successfully');
            } catch (error) {
                updateTestResults('❌ Error initializing OpenStreetMap: ' + error.message, 'danger');
                console.error('Error initializing OpenStreetMap:', error);
            }
        }

        // Test route plotting
        async function testRoute() {
            if (!mapsService || !mapsService.isInitialized) {
                updateTestResults('❌ Map not initialized', 'danger');
                return;
            }

            try {
                await mapsService.plotRoute('Delhi', 'Lucknow', 'test-route-1', {
                    routeColor: '#1976D2'
                });
                updateTestResults('✅ Route plotted successfully: Delhi → Lucknow', 'success');
            } catch (error) {
                updateTestResults('⚠️ Route plotting failed, using fallback: ' + error.message, 'warning');
            }
        }

        // Test Banaras to Haldwani route
        async function testBanarasRoute() {
            if (!mapsService || !mapsService.isInitialized) {
                updateTestResults('❌ Map not initialized', 'danger');
                return;
            }

            updateTestResults('🔍 Searching for Banaras and Haldwani coordinates...', 'info');
            
            try {
                await mapsService.plotRoute('Banaras', 'Haldwani', 'test-route-banaras', {
                    routeColor: '#4CAF50'
                });
                updateTestResults('✅ Route plotted successfully: Banaras → Haldwani', 'success');
            } catch (error) {
                updateTestResults('⚠️ Route plotting failed, using fallback: ' + error.message, 'warning');
            }
        }

        // Test bus marker
        function testBusMarker() {
            if (!mapsService || !mapsService.isInitialized) {
                updateTestResults('❌ Map not initialized', 'danger');
                return;
            }

            testBusCount++;
            const testBus = {
                busNumber: `TEST-${testBusCount}`,
                route: 'Test Route',
                status: 'running',
                driverName: 'Test Driver',
                conductorName: 'Test Conductor'
            };

            // Add bus at a random location around Delhi
            const lat = 28.6139 + (Math.random() - 0.5) * 2;
            const lng = 77.2090 + (Math.random() - 0.5) * 2;

            mapsService.updateBusLocation(`test-bus-${testBusCount}`, lat, lng, testBus);
            updateTestResults(`✅ Test bus ${testBus.busNumber} added at ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
        }

        // Test moving bus simulation
        function testMovingBus() {
            if (!mapsService || !mapsService.isInitialized) {
                updateTestResults('❌ Map not initialized', 'danger');
                return;
            }

            let moveCount = 0;
            const maxMoves = 10;
            let lat = 28.6139;
            let lng = 77.2090;

            const moveBus = setInterval(() => {
                moveCount++;
                
                // Simulate movement (small random changes)
                lat += (Math.random() - 0.5) * 0.1;
                lng += (Math.random() - 0.5) * 0.1;

                const movingBus = {
                    busNumber: 'MOVING-BUS',
                    route: 'Simulated Movement Route',
                    status: 'running',
                    driverName: 'Moving Driver',
                    conductorName: 'Moving Conductor'
                };

                mapsService.updateBusLocation('moving-bus', lat, lng, movingBus);

                if (moveCount >= maxMoves) {
                    clearInterval(moveBus);
                    updateTestResults(`✅ Moving bus simulation completed (${maxMoves} moves)`, 'success');
                } else {
                    updateTestResults(`🏃‍♂️ Moving bus... Step ${moveCount}/${maxMoves}`, 'info');
                }
            }, 1000);
        }

        // Clear map
        function clearMap() {
            if (!mapsService) {
                updateTestResults('❌ Map not initialized', 'danger');
                return;
            }

            // Remove all test journeys
            for (let i = 1; i <= testBusCount; i++) {
                mapsService.removeJourney(`test-bus-${i}`);
            }
            mapsService.removeJourney('moving-bus');
            mapsService.removeJourney('test-route-1');
            mapsService.removeJourney('test-route-banaras');

            testBusCount = 0;
            updateTestResults('🧹 Map cleared', 'info');
        }

        // Fit all buses
        function fitAllBuses() {
            if (!mapsService || !mapsService.isInitialized) {
                updateTestResults('❌ Map not initialized', 'danger');
                return;
            }

            mapsService.fitAllJourneys();
            updateTestResults('🔍 Map fitted to show all buses', 'info');
        }

        // Update test results
        function updateTestResults(message, type) {
            const resultsDiv = document.getElementById('testResults');
            const alertClass = `alert-${type}`;
            resultsDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof L !== 'undefined') {
                initMap();
            } else {
                setTimeout(() => initMap(), 500);
            }
        });
    </script>
</body>
</html>